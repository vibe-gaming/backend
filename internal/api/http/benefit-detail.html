<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Детали льготы</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .edit-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }

        .edit-btn:hover {
            background: #218838;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .content-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .content-section h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-item label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-item .value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .description {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .description h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .description p {
            color: #666;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 5px;
        }

        .badge-federal {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-regional {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-commercial {
            background: #fff3e0;
            color: #e65100;
        }

        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .tag {
            background: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Детали льготы</h1>
            <div class="header-actions">
                <button class="edit-btn" id="edit-btn" onclick="editBenefit()">Редактировать</button>
                <button class="delete-btn" id="delete-btn" onclick="deleteBenefit()">Удалить</button>
                <a href="/admin/benefits" class="back-btn">← Назад к списку</a>
            </div>
        </div>

        <div class="content-section">
            <div id="error-message"></div>
            <div id="benefit-container">
                <div class="loading">Загрузка...</div>
            </div>
        </div>
    </div>

    <script>
        async function loadBenefit() {
            const container = document.getElementById('benefit-container');
            const errorDiv = document.getElementById('error-message');
            errorDiv.innerHTML = '';
            
            // Получаем ID из URL
            const pathParts = window.location.pathname.split('/').filter(part => part);
            let benefitId = null;
            
            // Ищем ID после /admin/benefits/
            const benefitsIndex = pathParts.indexOf('benefits');
            if (benefitsIndex !== -1 && benefitsIndex + 1 < pathParts.length) {
                benefitId = pathParts[benefitsIndex + 1];
            } else {
                // Если не нашли, берем последний элемент
                benefitId = pathParts[pathParts.length - 1];
            }

            console.log('Извлеченный ID:', benefitId);
            console.log('Путь:', window.location.pathname);
            console.log('Части пути:', pathParts);

            if (!benefitId || benefitId === 'benefits' || benefitId === 'admin') {
                errorDiv.innerHTML = '<div class="error">ID льготы не указан в URL. Ожидается формат: /admin/benefits/{uuid}</div>';
                container.innerHTML = '';
                return;
            }

            // Проверяем формат UUID (базовая проверка)
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(benefitId)) {
                console.warn('ID не соответствует формату UUID:', benefitId);
                // Не блокируем запрос, но предупреждаем
            }

            container.innerHTML = '<div class="loading">Загрузка...</div>';

            try {
                console.log('Загрузка льготы с ID:', benefitId);
                const response = await fetch(`/api/v1/benefits/${benefitId}`);
                
                console.log('Статус ответа:', response.status, response.statusText);
                
                if (!response.ok) {
                    let errorMessage = 'Ошибка при загрузке льготы';
                    try {
                        const errorData = await response.json();
                        console.error('Ошибка от API:', errorData);
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        console.error('Ошибка парсинга ответа:', e);
                        // Если не удалось распарсить JSON, используем статус
                        if (response.status === 404) {
                            errorMessage = 'Льгота не найдена';
                        } else if (response.status === 401) {
                            errorMessage = 'Требуется авторизация';
                        } else if (response.status === 500) {
                            errorMessage = 'Внутренняя ошибка сервера';
                        } else {
                            errorMessage = `Ошибка ${response.status}: ${response.statusText}`;
                        }
                    }
                    throw new Error(errorMessage);
                }

                const benefit = await response.json();
                console.log('Получены данные льготы:', benefit);
                
                // Проверяем, что данные получены
                if (!benefit || !benefit.id) {
                    console.error('Некорректные данные:', benefit);
                    throw new Error('Некорректные данные льготы');
                }

                const typeLabels = {
                    'federal': 'Федеральная',
                    'regional': 'Региональная',
                    'commercial': 'Коммерческая'
                };

                const categoryLabels = {
                    'medicine': 'Медицина',
                    'transport': 'Транспорт',
                    'food': 'Питание',
                    'clothing': 'Одежда',
                    'education': 'Образование',
                    'payments': 'Выплаты',
                    'other': 'Другое'
                };

                const groupLabels = {
                    'pensioners': 'Пенсионеры',
                    'disabled': 'Инвалиды',
                    'young_families': 'Молодые семьи',
                    'low_income': 'Малоимущие',
                    'students': 'Студенты',
                    'large_families': 'Многодетные семьи',
                    'children': 'Дети',
                    'veterans': 'Ветераны'
                };

                const typeClass = `badge-${benefit.type}`;
                const typeLabel = typeLabels[benefit.type] || benefit.type;
                const categoryLabel = benefit.category ? categoryLabels[benefit.category] || benefit.category : 'Не указано';
                
                const validFrom = benefit.valid_from ? new Date(benefit.valid_from).toLocaleDateString('ru-RU') : 'Не указано';
                const validTo = benefit.valid_to ? new Date(benefit.valid_to).toLocaleDateString('ru-RU') : 'Не указано';
                const createdAt = new Date(benefit.created_at).toLocaleDateString('ru-RU');
                const updatedAt = new Date(benefit.updated_at).toLocaleDateString('ru-RU');

                let targetGroupsHTML = '';
                if (benefit.target_groups && benefit.target_groups.length > 0) {
                    targetGroupsHTML = benefit.target_groups.map(group => 
                        `<span class="tag">${groupLabels[group] || group}</span>`
                    ).join('');
                } else {
                    targetGroupsHTML = '<span class="tag">Не указано</span>';
                }

                let tagsHTML = '';
                if (benefit.tags && benefit.tags.length > 0) {
                    tagsHTML = benefit.tags.map(tag => 
                        `<span class="tag">${tag}</span>`
                    ).join('');
                } else {
                    tagsHTML = '<span class="tag">Нет тегов</span>';
                }

                let organizationHTML = '';
                if (benefit.organization) {
                    organizationHTML = `
                        <div class="info-item">
                            <label>Организация</label>
                            <div class="value">${escapeHtml(benefit.organization.name)}</div>
                        </div>
                    `;
                }

                let cityHTML = '';
                if (benefit.city_id) {
                    cityHTML = `
                        <div class="info-item">
                            <label>Город ID</label>
                            <div class="value">${benefit.city_id}</div>
                        </div>
                    `;
                }

                const html = `
                    <h2>${escapeHtml(benefit.title)}</h2>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Тип</label>
                            <div class="value"><span class="badge ${typeClass}">${typeLabel}</span></div>
                        </div>
                        <div class="info-item">
                            <label>Категория</label>
                            <div class="value">${categoryLabel}</div>
                        </div>
                        <div class="info-item">
                            <label>Просмотры</label>
                            <div class="value">${benefit.views || 0}</div>
                        </div>
                        <div class="info-item">
                            <label>Действует с</label>
                            <div class="value">${validFrom}</div>
                        </div>
                        <div class="info-item">
                            <label>Действует до</label>
                            <div class="value">${validTo}</div>
                        </div>
                        <div class="info-item">
                            <label>Создано</label>
                            <div class="value">${createdAt}</div>
                        </div>
                        <div class="info-item">
                            <label>Обновлено</label>
                            <div class="value">${updatedAt}</div>
                        </div>
                        ${organizationHTML}
                        ${cityHTML}
                    </div>

                    <div class="info-item" style="margin-top: 20px;">
                        <label>Целевые группы</label>
                        <div class="tags-list">${targetGroupsHTML}</div>
                    </div>

                    <div class="info-item" style="margin-top: 20px;">
                        <label>Теги</label>
                        <div class="tags-list">${tagsHTML}</div>
                    </div>

                    <div class="description">
                        <h3>Описание</h3>
                        <p>${escapeHtml(benefit.description || 'Не указано')}</p>
                    </div>

                    ${benefit.requirement ? `
                    <div class="description" style="margin-top: 20px;">
                        <h3>Требования</h3>
                        <p>${escapeHtml(benefit.requirement)}</p>
                    </div>
                    ` : ''}

                    ${benefit.how_to_use ? `
                    <div class="description" style="margin-top: 20px;">
                        <h3>Как использовать</h3>
                        <p>${escapeHtml(benefit.how_to_use)}</p>
                    </div>
                    ` : ''}

                    ${benefit.source_url ? `
                    <div class="info-item" style="margin-top: 20px;">
                        <label>Ссылка на источник</label>
                        <div class="value"><a href="${benefit.source_url}" target="_blank">${escapeHtml(benefit.source_url)}</a></div>
                    </div>
                    ` : ''}
                `;

                container.innerHTML = html;

            } catch (error) {
                console.error('Ошибка при загрузке льготы:', error);
                errorDiv.innerHTML = `<div class="error">Ошибка: ${error.message}<br><small>Проверьте консоль браузера для деталей</small></div>`;
                container.innerHTML = '';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function editBenefit() {
            // Получаем ID из URL
            const pathParts = window.location.pathname.split('/').filter(part => part);
            let benefitId = null;
            
            const benefitsIndex = pathParts.indexOf('benefits');
            if (benefitsIndex !== -1 && benefitsIndex + 1 < pathParts.length) {
                benefitId = pathParts[benefitsIndex + 1];
            } else {
                benefitId = pathParts[pathParts.length - 1];
            }

            if (benefitId && benefitId !== 'benefits' && benefitId !== 'admin') {
                // Перенаправляем на страницу создания с параметром редактирования
                window.location.href = `/admin/create-benefit?edit=true&id=${benefitId}`;
            } else {
                alert('Не удалось определить ID льготы');
            }
        }

        // Загружаем данные при загрузке страницы
        window.addEventListener('DOMContentLoaded', () => {
            loadBenefit();
        });
    </script>
</body>
</html>

