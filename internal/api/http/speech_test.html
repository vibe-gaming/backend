<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–µ—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ MP3 -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 600px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .auth-section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .auth-section label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
      }

      .auth-section input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e4e8;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .auth-section input:focus {
        outline: none;
        border-color: #667eea;
      }

      .record-section {
        text-align: center;
        margin: 30px 0;
      }

      .record-button {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 48px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      }

      .record-button:hover {
        transform: scale(1.1);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
      }

      .record-button:active {
        transform: scale(0.95);
      }

      .record-button.recording {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .status {
        margin-top: 15px;
        color: #666;
        font-size: 14px;
      }

      .file-upload {
        margin: 30px 0;
        padding: 20px;
        border: 2px dashed #667eea;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .file-upload:hover {
        background: #f8f9fa;
        border-color: #764ba2;
      }

      .file-upload input {
        display: none;
      }

      .button {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 10px;
      }

      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      }

      .button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .result {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }

      .result h3 {
        color: #333;
        margin-bottom: 10px;
      }

      .result p {
        color: #555;
        line-height: 1.6;
      }

      .error {
        background: #fff5f5;
        border-left-color: #f5576c;
      }

      .error h3 {
        color: #f5576c;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üé§ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏</h1>
      <p class="subtitle">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Gigachat Speech-to-Text API</p>

      <div class="auth-section">
        <label for="token">JWT —Ç–æ–∫–µ–Ω:</label>
        <input type="text" id="token" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à JWT —Ç–æ–∫–µ–Ω" />
        <div
          style="
            margin-top: 10px;
            padding: 10px;
            background: #d1ecf1;
            border-radius: 5px;
            font-size: 12px;
            color: #0c5460;
          "
        >
          <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> Gigachat –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ MP3
          —Ñ–æ—Ä–º–∞—Ç.<br />
          –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∞—É–¥–∏–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ MP3.
        </div>
      </div>

      <div class="record-section">
        <button class="record-button" id="recordBtn">üéôÔ∏è</button>
        <div class="status" id="status">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏</div>
      </div>

      <div class="file-upload" id="fileUpload">
        <input
          type="file"
          id="fileInput"
          accept="audio/*,.mp3,.wav,.ogg,.m4a,.mp4"
        />
        <p>üìÅ –ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª</p>
        <small style="color: #999"
          >–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ª—é–±—ã–µ –∞—É–¥–∏–æ —Ñ–æ—Ä–º–∞—Ç—ã (–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ MP3)</small
        >
      </div>

      <button class="button" id="uploadBtn" disabled>
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
      </button>

      <div class="result hidden" id="result"></div>
    </div>

    <script>
      let mediaRecorder;
      let audioChunks = [];
      let audioBlob = null;

      const recordBtn = document.getElementById("recordBtn");
      const status = document.getElementById("status");
      const fileInput = document.getElementById("fileInput");
      const fileUpload = document.getElementById("fileUpload");
      const uploadBtn = document.getElementById("uploadBtn");
      const result = document.getElementById("result");
      const tokenInput = document.getElementById("token");

      // –ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
      recordBtn.addEventListener("click", async () => {
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: {
                channelCount: 1,
                sampleRate: 16000,
              },
            });

            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π MIME-—Ç–∏–ø
            const mimeTypes = [
              "audio/webm;codecs=opus",
              "audio/webm",
              "audio/ogg;codecs=opus",
              "audio/ogg",
            ];

            let selectedMime = null;
            for (const mime of mimeTypes) {
              if (MediaRecorder.isTypeSupported(mime)) {
                selectedMime = mime;
                break;
              }
            }

            if (!selectedMime) {
              showError(
                "–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é Chrome, Edge –∏–ª–∏ Firefox."
              );
              return;
            }

            mediaRecorder = new MediaRecorder(stream, {
              mimeType: selectedMime,
            });

            mediaRecorder.ondataavailable = (event) => {
              audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
              const recordedMime = mediaRecorder.mimeType || selectedMime;
              let blob = new Blob(audioChunks, { type: recordedMime });
              audioChunks = [];

              // –í—Å–µ–≥–¥–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ MP3 –¥–ª—è Gigachat
              status.textContent = "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏ –≤ MP3...";
              try {
                blob = await convertToMp3(blob);
                status.textContent = "–ó–∞–ø–∏—Å—å –≥–æ—Ç–æ–≤–∞ (—Ñ–æ—Ä–º–∞—Ç MP3)";
              } catch (e) {
                showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å: " + e.message);
                stream.getTracks().forEach((track) => track.stop());
                recordBtn.classList.remove("recording");
                uploadBtn.disabled = true;
                mediaRecorder = null;
                return;
              }

              audioBlob = blob;
              uploadBtn.disabled = false;
              recordBtn.classList.remove("recording");

              stream.getTracks().forEach((track) => track.stop());
            };

            mediaRecorder.start();
            recordBtn.classList.add("recording");
            recordBtn.textContent = "‚èπÔ∏è";
            status.textContent = "–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å... –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏";
          } catch (error) {
            showError("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + error.message);
          }
        } else {
          mediaRecorder.stop();
          recordBtn.textContent = "üéôÔ∏è";
        }
      });

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
      fileUpload.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (file) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª
          if (!file.type.startsWith("audio/")) {
            showError("–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª");
            uploadBtn.disabled = true;
            audioBlob = null;
            return;
          }

          status.textContent = `–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ${file.name}. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ MP3...`;
          uploadBtn.disabled = true;

          try {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ MP3
            audioBlob = await convertToMp3(file);
            uploadBtn.disabled = false;
            status.textContent = `–§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ (—Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ MP3)`;
          } catch (e) {
            showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª: " + e.message);
            uploadBtn.disabled = true;
            audioBlob = null;
          }
        }
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      uploadBtn.addEventListener("click", async () => {
        const token = tokenInput.value.trim();

        if (!token) {
          showError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω");
          return;
        }

        if (!audioBlob) {
          showError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–∏—à–∏—Ç–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª");
          return;
        }

        uploadBtn.disabled = true;
        uploadBtn.textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";

        try {
          const formData = new FormData();
          // –í—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ MP3
          formData.append("audio", audioBlob, "audio.mp3");

          const response = await fetch("/api/v1/speech/recognize", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const data = await response.json();

          if (response.ok) {
            showResult(data.text);
          } else {
            showError(data.error || data.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏");
          }
        } catch (error) {
          showError("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + error.message);
        } finally {
          uploadBtn.disabled = false;
          uploadBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ";
        }
      });

      // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∞—É–¥–∏–æ –≤ MP3 –∏—Å–ø–æ–ª—å–∑—É—è lamejs
      async function convertToMp3(blob) {
        // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∞—É–¥–∏–æ
        const arrayBuffer = await blob.arrayBuffer();
        const audioCtx = new (window.AudioContext ||
          window.webkitAudioContext)();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è MP3
        const sampleRate = 16000; // 16kHz –¥–ª—è —Ä–µ—á–∏
        const channels = 1; // –º–æ–Ω–æ
        const kbps = 128; // –∫–∞—á–µ—Å—Ç–≤–æ

        // –†–µ—Å–µ–º–ø–ª–∏—Ä—É–µ–º –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–æ–Ω–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        let samples;
        if (
          audioBuffer.sampleRate !== sampleRate ||
          audioBuffer.numberOfChannels !== 1
        ) {
          const offlineCtx = new OfflineAudioContext(
            channels,
            audioBuffer.duration * sampleRate,
            sampleRate
          );

          const source = offlineCtx.createBufferSource();
          source.buffer = audioBuffer;
          source.connect(offlineCtx.destination);
          source.start(0);

          const resampledBuffer = await offlineCtx.startRendering();
          samples = resampledBuffer.getChannelData(0);
        } else {
          samples = audioBuffer.getChannelData(0);
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Float32Array –≤ Int16Array –¥–ª—è MP3 —ç–Ω–∫–æ–¥–µ—Ä–∞
        const samplesInt16 = new Int16Array(samples.length);
        for (let i = 0; i < samples.length; i++) {
          let s = Math.max(-1, Math.min(1, samples[i]));
          samplesInt16[i] = s < 0 ? s * 0x8000 : s * 0x7fff;
        }

        // –°–æ–∑–¥–∞–µ–º MP3 —ç–Ω–∫–æ–¥–µ—Ä
        const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, kbps);
        const mp3Data = [];

        const blockSize = 1152; // —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ –¥–ª—è MP3
        for (let i = 0; i < samplesInt16.length; i += blockSize) {
          const samplesBlock = samplesInt16.subarray(i, i + blockSize);
          const mp3buf = mp3encoder.encodeBuffer(samplesBlock);
          if (mp3buf.length > 0) {
            mp3Data.push(mp3buf);
          }
        }

        // –ó–∞–≤–µ—Ä—à–∞–µ–º –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
        const mp3buf = mp3encoder.flush();
        if (mp3buf.length > 0) {
          mp3Data.push(mp3buf);
        }

        // –°–æ–∑–¥–∞–µ–º blob –∏–∑ MP3 –¥–∞–Ω–Ω—ã—Ö
        return new Blob(mp3Data, { type: "audio/mp3" });
      }

      function showResult(text) {
        result.className = "result";
        result.innerHTML = `
                <h3>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:</h3>
                <p>${text}</p>
            `;
      }

      function showError(message) {
        result.className = "result error";
        result.innerHTML = `
                <h3>‚ùå –û—à–∏–±–∫–∞:</h3>
                <p>${message}</p>
            `;
      }
    </script>
  </body>
</html>
